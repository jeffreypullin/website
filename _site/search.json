[
  {
    "objectID": "posts/knn-uncertainty/index.html",
    "href": "posts/knn-uncertainty/index.html",
    "title": "Visualising uncertainty in KNN graphs for scRNAseq data",
    "section": "",
    "text": "In this post I describe an idea for quantifying and visualizing uncertainty in k-nearest neighbour (KNN) graphs in single-cell RNA sequencing data.\nKNN graphs are an important tool in single-cell analysis: they are used to cluster cells, as part of algorithms that are commonly used to visualise scRNA-seq and have recently been used to develop ‘cluster-free’ differential expression and abundance testing methods (milo and miloDE).\nDespite this widespread use I am not aware of any work to date that seeks to quantify how uncertain we might be about the KNN graph we build and work with.\nIn this post I suggest using recent advances in ‘data thinning’ scRNAseq to quanity this uncertainty. Briefly, data thinning methods allow a scRNAseq dataset to be ‘partitioned’ into multiple independent datasets: each entry in the count matrix is split into multiple counts in such a way that the split counts are independent. The partitioned datasets can then be used in a similar way to data split using traditional test-training set splitting.\nI illustrate my idea on the ‘traditional’ pbmc3k dataset. First we load some relevant libraries.\n\nlibrary(TENxPBMCData)\nlibrary(edgeR)\nlibrary(datathin)\nlibrary(scater)\nlibrary(scran)\nlibrary(igraph)\nlibrary(tidyverse)\n\nNext, we load the pbm3k data, and quickly process it using standard Biocondutor packages. Specifically we:\n\nNormalize the data,\nFilter the highly variable gene,\nCompute a PCA reduced dimensionality representation,\nCompute a tSNE reduced dimensionality representation (uses the KNN graph), and\nCluster the data (uses the KNN graph).\n\n\nset.seed(42)\npbmc3k <- TENxPBMCData(\"pbmc3k\")\nrownames(pbmc3k) <- rowData(pbmc3k)$Symbol_TENx\n\nclust <- quickCluster(pbmc3k)\npbmc3k <- computeSumFactors(pbmc3k, cluster = clust, min.mean = 0.1)\npbmc3k <- logNormCounts(pbmc3k)\n\ndec_pbmc3k <- modelGeneVar(pbmc3k)\nchosen <- getTopHVGs(dec_pbmc3k, prop = 0.2)\npbmc3k <- pbmc3k[chosen, ]\n\npbmc3k <- runPCA(pbmc3k)\npbmc3k <- runTSNE(pbmc3k)\n\nclusters <- clusterCells(pbmc3k, use.dimred = \"PCA\")\ncolLabels(pbmc3k) <- clusters\n\nAfter these steps we can plot the dataset’s 2D tSNE representation, colouring by the assigned cluster of each cell. We can observe that the clustering algorithm finds 10 clusters with and there are three broad clusters visible in the tSNE representation.\n\nplotTSNE(pbmc3k, colour_by = \"label\")\n\n\n\n\nA perennial question in single-cell RNA-seq analysis is are the clusters we computationally identified ‘real’? Here by real we generally mean corresponding to well-defined biological cell-types.\nTo understand this for a given dataset I propose trying to measure our uncertainty about which cells are each cells k-nearest neighbors. Cells with more uncertainty about their neighbors are likely to be more difficult to cluster and therefore more likely to be incorrectly clustered.\nTo measure this we split the dataset into multiple fold dataset (in this case 5) using the {datathin} package, which implements the recently proposed data thinning methodology.\n\nn_folds <- 5\nfolds <- multithin(as.matrix(counts(pbmc3k)), family = \"poisson\", \n                   nfolds = n_folds, eps = rep(0.2, 5), arg = 1)\n\nWe then process normalize and cluster each of the fold datasets. Crucially, with the option full = TRUE we calculated the full KNN graph for each dataset.\n\nsce_list <- list()\nclust_list <- list()\nfor (i in seq_len(n_folds)) {\n  sce_list[[i]] <- SingleCellExperiment(assays = list(counts = folds[[i]]))\n  sce_list[[i]] <- logNormCounts(sce_list[[i]])\n  sce_list[[i]] <- runPCA(sce_list[[i]])\n  clust_list[[i]] <- clusterCells(sce_list[[i]], use.dimred = \"PCA\", full = TRUE)\n}\n\nNext, for each cell in the dataset we calculate the proportion of it’s k-nearest neighbors that are common across all the folds divided by the total number of k-nearest neighbors across all folds. This measures how consistent the found KNNs are for each cell in the dataset.\n\nn_cells <- ncol(pbmc3k)\nprop <- numeric(n_cells)\nfor (i in seq_len(n_cells)) {\n  tmp <- c()\n  tmp_list <- list()\n  for (j in seq_len(n_folds)) {\n    tmp <- c(tmp, neighbors(clust_list[[j]]$objects$graph, i))\n    tmp_list[[j]] <- neighbors(clust_list[[j]]$objects$graph, i)\n  }\n  in_all <- Reduce(intersect, tmp_list)\n  prop[[i]] <- length(in_all) / length(tmp)\n}\n\nFinally we plot the tSNE again, coloured by the log of the proportion we calculated.\n\npbmc3k$test <- log(prop, base = 10)\nplotTSNE(pbmc3k, colour_by = \"test\")\n\n\n\n\nWe can see that cells in the B cell, monocytes and NK cells cluster have generally high (log) proportions but those in in T cells clusters do not. Cell at the edge of the clusters in tSNE space also have generally lower proportions.\nThese results suggest that clustering the T-cells is generally going to be less reliable, so perhaps any T-cell sub-clusters are not (or at least less) biologically meaningful.\nThe method presented in this post is clearly half-baked but if it is of interest to anyone please get in touch!"
  },
  {
    "objectID": "index.html",
    "href": "index.html",
    "title": "Jeffrey Pullin",
    "section": "",
    "text": "Visualising uncertainty in KNN graphs for scRNAseq data\n\n\n\n\n\n\n\n\n\n\n\n\nMar 31, 2023\n\n\nJeffrey Pullin\n\n\n\n\n\n\nNo matching items"
  },
  {
    "objectID": "about.html",
    "href": "about.html",
    "title": "Jeffrey Pullin",
    "section": "",
    "text": "Hi, welcome! A little about me:\nCurrently, I am working as a Senior Analyst/Statistician at the Victorian Agency for Health Information, part of the Victorian Department of Health.\nLater this year, I will start a PhD in the MRC Biostatistics Unit at the University of Cambridge, supervised by Dr Chris Wallace. My project will focus on improving statistical methodology for performing colocalisation analysis in genetics, with a particular focus on the ‘coloc’ software.\nPreviously, I completed a Master of Science (Mathematics and Statistics) at the University of Melbourne. My thesis, supervised by Dr Davis McCarthy, compared different statistical methods for selecting genes that distinguish biological cell-types in single-cell RNA-sequencing data. I won the Dwight Prize in Mathematical Statistics as the highest-scoring student in the statistics and stochastic processes specialization in the MSc.\nBefore that, I worked as a graduate at the Australian Institute of Health and Welfare and as a part-time research assistant in Wayne Crismani’s Lab at the St Vincent’s Institute of Medical Research. I completed my BSc (Mathematics and Statistics) at the University of Melbourne in 2018.\nIn my spare time, I like to run, read and do cryptic crosswords, with the hope of one day finishing a DA cryptic…"
  }
]